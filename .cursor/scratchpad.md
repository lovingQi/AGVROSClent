# AGV监控系统项目计划

## 背景和动机
用户需要开发一个网页应用，可以在局域网中监控多台运行ROS1的AGV小车。此应用需要显示所有小车的运动状态，并能查看每台小车上的ROS消息情况。

## 关键挑战和分析
1. 需要从运行ROS1的多台AGV小车收集数据
2. 需要在网页上实时显示这些数据
3. 需要建立从ROS1到网页的通信桥梁
4. 需要设计用户友好的界面来显示小车状态和消息
5. 解决rosbridge_server不支持get_topics操作的问题，需要使用替代方法获取话题列表

## 技术栈分析
### 后端
- Node.js作为Web服务器
- Express框架用于API开发
- TypeScript提供类型安全和更好的开发体验
- Socket.IO：实现服务器与客户端的实时通信
- rosbridge_suite：将ROS消息转换为WebSocket消息，实现ROS与Web应用的通信

### 前端
- React：构建用户界面
- TypeScript：提供类型检查和开发支持
- Ant Design：UI组件库
- Socket.IO-client：与后端实现实时通信
- 自定义RosConnection模块：处理与ROS的通信

## 详细系统架构

### 整体架构
```
+------------------+      +-------------------+      +------------------+
|                  |      |                   |      |                  |
|  AGV 1 (ROS1)    |      |  AGV 2 (ROS1)     |      |  AGV N (ROS1)    |
|  + rosbridge     |      |  + rosbridge      |      |  + rosbridge     |
|                  |      |                   |      |                  |
+--------+---------+      +--------+----------+      +--------+---------+
         |                         |                           |
         |  WebSocket              |  WebSocket                |  WebSocket
         |                         |                           |
+------------------------------------------------------------------+
|                                                                  |
|                       后端服务器 (Node.js)                        |
|                                                                  |
|  +-----------------+    +-------------------+    +-------------+ |
|  | Express API服务  |    | Socket.IO服务     |    | ROS代理服务  | |
|  +-----------------+    +-------------------+    +-------------+ |
|                                                                  |
+---------------------------+------------------------------------+--+
                            |
                            | HTTP/WebSocket
                            |
+---------------------------+------------------------------------+
|                                                                |
|                       React Web应用                            |
|                                                                |
|  +----------------+    +----------------+    +----------------+ |
|  | 首页/AGV列表    |    | AGV详情页面    |    | 参数配置页面    | |
|  +----------------+    +----------------+    +----------------+ |
|                                                                 |
+-----------------------------------------------------------------+
```

### 后端架构详解

#### 1. 核心服务
- **RosProxyService**: 代理与AGV上rosbridge的WebSocket通信，提供与ROS系统的接口
- **RosService**: 处理与单个AGV ROS系统的交互，包括连接管理、话题订阅等
- **AgvManager**: 管理多个AGV的连接和状态，提供统一的接口
- **SocketService**: 管理与前端的Socket.IO连接，处理实时消息推送

#### 2. 数据流
```
AGV(ROS) → rosbridge_server → WebSocket → RosProxyService → SocketService → 前端
```

#### 3. 主要API路由
- `/api/agvs`: 获取所有AGV状态
- `/api/agv/:id`: 获取指定AGV详情

### 前端架构详解

#### 1. 组件结构
- **App**: 应用根组件，处理路由
- **HomePage**: 首页，显示AGV列表
- **AGVDetailPage**: AGV详情页面，显示单个AGV信息和ROS话题
- **RosDataVisualizer**: ROS数据可视化组件
- **ParamsViewer**: 参数配置页面

#### 2. 通信模块
- **RosConnection**: 处理与后端的Socket.IO连接和ROS通信
- **API Services**: 封装对后端API的请求

#### 3. 数据流
```
用户界面 → 组件状态 → RosConnection → Socket.IO → 后端 → ROS
```

### ROS通信流程

#### 1. 连接建立流程
```
前端 → 连接Socket.IO → 发送ros:connect → 后端创建到rosbridge的连接 → 返回连接状态
```

#### 2. 话题订阅流程
```
1. 获取话题列表: 前端 → 调用ROS服务(/rosapi/topics) → 获取可用话题
2. 订阅话题: 前端 → 发送subscribe操作 → 后端转发到rosbridge → rosbridge订阅ROS话题
3. 消息接收: ROS → rosbridge → 后端 → Socket.IO → 前端RosConnection → 组件状态更新 → 界面显示
```

## 高层任务拆分
1. 环境搭建
   - 在开发环境安装Node.js和npm
   - 创建React项目框架
   - 创建必要的目录结构

2. 后端开发
   - 设计服务器架构
   - 实现WebSocket服务器与rosbridge的连接
   - 开发API接口获取AGV信息

3. 前端开发
   - 创建主页面布局
   - 实现AGV列表组件
   - 开发AGV详情查看页面
   - 实现ROS消息订阅和显示功能

4. 数据通信实现
   - 实现前后端WebSocket通信
   - 开发ROS消息处理模块
   - 实现实时数据更新机制

5. 测试和优化
   - 进行单元测试
   - 在模拟环境中测试与ROS的通信
   - 实际AGV测试部署

## 项目状态看板
- [x] 项目规划完成
- [x] 环境搭建
  - [x] 创建项目基础目录结构
  - [x] 配置前端开发环境
  - [x] 配置后端开发环境
- [x] 后端开发
  - [x] 设计服务器架构
  - [x] 实现与ROS的通信
  - [x] 开发API接口
  - [x] 实现WebSocket服务
- [x] 前端开发
  - [x] 创建主页面布局
  - [x] 实现AGV列表组件
  - [x] 开发AGV详情查看页面
  - [x] 实现ROS消息订阅功能
  - [x] 修复roslib类型定义问题
  - [x] 实现话题列表获取功能
- [x] 数据通信实现
  - [x] 实现前后端WebSocket通信
  - [x] 开发ROS消息处理模块
  - [x] 解决rosbridge_server不支持get_topics的问题
- [ ] 测试和优化
  - [ ] 安装依赖并运行前后端
  - [ ] 测试与ROS的通信
  - [ ] 实际AGV测试部署

## 执行者反馈或请求帮助
已完成项目的核心代码实现，包括前端和后端的所有主要功能。解决了几个关键技术问题：

1. 修复了前端TypeScript中roslib库的类型定义问题，通过创建自定义类型声明文件解决
2. 解决了rosbridge_server不支持get_topics操作的问题，改用call_service操作调用/rosapi/topics服务获取话题列表
3. 实现了在前端动态订阅和显示ROS话题消息的功能
4. 优化了前端界面，使其能够更好地显示AGV状态和消息

下一步需要在实际环境中安装依赖并运行前后端，然后进行与ROS的通信测试。

## 经验教训
1. 使用rosbridge_suite可以有效地将ROS系统与Web应用连接起来，避免了在浏览器中直接运行ROS的复杂性。
2. 使用Socket.IO实现实时通信，可以轻松地将ROS消息推送到前端。
3. 在前端使用Ant Design组件库可以快速构建美观的用户界面。
4. 当遇到第三方库的类型定义问题时，可以通过创建自定义类型声明文件来解决。
5. rosbridge_server不支持get_topics操作，需要使用call_service操作调用/rosapi/topics服务获取话题列表。
6. 在处理ROS消息时，需要注意消息的格式和类型，确保前端能够正确解析和显示。 